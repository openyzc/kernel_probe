<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="zh-CN"><!--<![endif]--><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>理解Linux的memory overcommit | Linux Performance</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://linuxperf.com/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="http://linuxperf.com/wp-content/themes/twentyfourteen/js/html5.js"></script>
	<![endif]-->
	<link rel="dns-prefetch" href="http://fonts.googleapis.com/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link href="https://fonts.gstatic.com/" crossorigin="" rel="preconnect">
<link rel="alternate" type="application/rss+xml" title="Linux Performance » Feed" href="http://linuxperf.com/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="Linux Performance » 评论Feed" href="http://linuxperf.com/?feed=comments-rss2">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/linuxperf.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.5"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/wp-emoji-release.js" type="text/javascript" defer="defer"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="crayon-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/crayon.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-theme-classic-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/classic.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-font-monaco-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/monaco.css" type="text/css" media="all">
<link rel="stylesheet" id="twentyfourteen-lato-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/css.css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/genericons.css" type="text/css" media="all">
<link rel="stylesheet" id="twentyfourteen-style-css" href="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/style.css" type="text/css" media="all">
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyfourteen-ie-css'  href='http://linuxperf.com/wp-content/themes/twentyfourteen/css/ie.css?ver=20131205' type='text/css' media='all' />
<![endif]-->
<script type="text/javascript" src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/jquery.js"></script>
<script type="text/javascript" src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/jquery-migrate.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"http:\/\/linuxperf.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"\u4f7f\u7528 %s \u590d\u5236\uff0c\u4f7f\u7528 %s \u7c98\u8d34\u3002","minimize":"\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801"};
/* ]]> */
</script>
<script type="text/javascript" src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/crayon.js"></script>
<link rel="https://api.w.org/" href="http://linuxperf.com/?rest_route=/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://linuxperf.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://linuxperf.com/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="解读vmstat中的active/inactive memory" href="http://linuxperf.com/?p=97">
<link rel="next" title="怎样诊断Machine-check Exception" href="http://linuxperf.com/?p=105">
<meta name="generator" content="WordPress 4.7.5">
<link rel="canonical" href="http://linuxperf.com/?p=102">
<link rel="shortlink" href="http://linuxperf.com/?p=102">
<link rel="alternate" type="application/json+oembed" href="http://linuxperf.com/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Flinuxperf.com%2F%3Fp%3D102">
<link rel="alternate" type="text/xml+oembed" href="http://linuxperf.com/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Flinuxperf.com%2F%3Fp%3D102&amp;format=xml">
</head>

<body class="post-template-default single single-post postid-102 single-format-standard masthead-fixed full-width singular">
<div id="page" class="hfeed site">
	
	<header id="masthead" class="site-header" role="banner">
		<div class="header-main">
			<h1 class="site-title"><a href="http://linuxperf.com/" rel="home">Linux Performance</a></h1>

			<div class="search-toggle">
				<a href="#search-container" class="screen-reader-text" aria-expanded="false" aria-controls="search-container">搜索</a>
			</div>

			<nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
				<button class="menu-toggle">主菜单</button>
				<a class="screen-reader-text skip-link" href="#content">跳至内容</a>
				<div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container"><ul id="primary-menu" class="nav-menu"><li id="menu-item-8" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8"><a href="http://linuxperf.com/?page_id=2">About</a></li>
<li id="menu-item-7" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-7"><a href="http://linuxperf.com/?feed=rss2">订阅</a></li>
</ul></div>			</nav>
		</div>

		<div id="search-container" class="search-box-wrapper hide">
			<div class="search-box">
				<form role="search" method="get" class="search-form" action="http://linuxperf.com/">
				<label>
					<span class="screen-reader-text">搜索：</span>
					<input class="search-field" placeholder="搜索…" name="s" type="search">
				</label>
				<input class="search-submit" value="搜索" type="submit">
			</form>			</div>
		</div>
	</header><!-- #masthead -->

	<div id="main" class="site-main">

	<div id="primary" class="content-area">
		<div id="content" class="site-content" role="main">
			
<article id="post-102" class="post-102 post type-post status-publish format-standard hentry category-7">
	
	<header class="entry-header">
				<div class="entry-meta">
			<span class="cat-links"><a href="http://linuxperf.com/?cat=7" rel="category">内存</a></span>
		</div>
		<h1 class="entry-title">理解Linux的memory overcommit</h1>
		<div class="entry-meta">
			<span class="entry-date"><a href="http://linuxperf.com/?p=102" rel="bookmark"><time class="entry-date" datetime="2016-02-19T22:10:59+00:00">2016/02/19</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="http://linuxperf.com/?author=1" rel="author">vmunix</a></span></span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>Memory Overcommit的意思是操作系统承诺给进程的内存大小超过了实际可用的内存。一个保守的操作系统不会允许memory 
overcommit，有多少就分配多少，再申请就没有了，这其实有些浪费内存，因为进程实际使用到的内存往往比申请的内存要少，比如某个进程
malloc()了200MB内存，但实际上只用到了100MB，按照UNIX/Linux的算法，物理内存页的分配发生在使用的瞬间，而不是在申请的瞬
间，也就是说未用到的100MB内存根本就没有分配，这100MB内存就闲置了。下面这个概念很重要，是理解memory 
overcommit的关键：commit(或overcommit)针对的是内存申请，内存申请不等于内存分配，内存只在实际用到的时候才分配。</p>
<p>Linux是允许memory 
overcommit的，只要你来申请内存我就给你，寄希望于进程实际上用不到那么多内存，但万一用到那么多了呢？那就会发生类似“银行挤兑”的危机，现
金(内存)不足了。Linux设计了一个OOM killer机制(OOM = 
out-of-memory)来处理这种危机：挑选一个进程出来杀死，以腾出部分内存，如果还不够就继续杀…也可通过设置内核参数 
vm.panic_on_oom 
使得发生OOM时自动重启系统。这都是有风险的机制，重启有可能造成业务中断，杀死进程也有可能导致业务中断，我自己的这个小网站就碰到过这种问题，<a href="http://linuxperf.com/?p=94" target="_blank">参见前文</a>。所以Linux 2.6之后允许通过内核参数 vm.overcommit_memory 禁止memory overcommit。</p>
<p>内核参数 vm.overcommit_memory 接受三种取值：</p>
<ul>
<li>0 –&nbsp;Heuristic overcommit handling. 
这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。
Heuristic的意思是“试探式的”，内核利用某种算法（对该算法的详细解释请看文末）猜测你的内存申请是否合理，它认为不合理就会拒绝
overcommit。</li>
<li>1 – Always overcommit. 允许overcommit，对内存申请来者不拒。</li>
<li>2 – Don’t overcommit. 禁止overcommit。</li>
</ul>
<p>关于禁止overcommit (vm.overcommit_memory=2) 
，需要知道的是，怎样才算是overcommit呢？kernel设有一个阈值，申请的内存总数超过这个阈值就算overcommit，在/proc
/meminfo中可以看到这个阈值的大小：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-59b753a515173575626032" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft"># grep -i commit /proc/meminfo
CommitLimit:     5967744 kB
Committed_AS:    5363236 kB</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="margin-left: -18px;">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59b753a515173575626032-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a515173575626032-2">2</div><div class="crayon-num" data-line="crayon-59b753a515173575626032-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59b753a515173575626032-1"><span class="crayon-p"># grep -i commit /proc/meminfo</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a515173575626032-2"><span class="crayon-v">CommitLimit</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5967744</span><span class="crayon-h"> </span><span class="crayon-e">kB</span></div><div class="crayon-line" id="crayon-59b753a515173575626032-3"><span class="crayon-v">Committed_AS</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5363236</span><span class="crayon-h"> </span><span class="crayon-v">kB</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>CommitLimit 就是overcommit的阈值，申请的内存总数超过CommitLimit的话就算是overcommit。<br>
这个阈值是如何计算出来的呢？它既不是物理内存的大小，也不是free memory的大小，它是通过内核参数vm.overcommit_ratio或vm.overcommit_kbytes间接设置的，公式如下：<br>
【CommitLimit = (Physical RAM * vm.overcommit_ratio / 100) + Swap】</p>
<p style="padding-left: 30px;">注：<br>
vm.overcommit_ratio 是内核参数，缺省值是50，表示物理内存的50%。如果你不想使用比率，也可以直接指定内存的字节数大小，通过另一个内核参数 vm.overcommit_kbytes 即可；<br>
如果使用了huge pages，那么需要从物理内存中减去，公式变成：<br>
CommitLimit = ([total RAM] – [total huge TLB RAM]) * vm.overcommit_ratio / 100 + swap<br>
参见<a href="https://access.redhat.com/solutions/665023" target="_blank">https://access.redhat.com/solutions/665023</a></p>
<p>/proc/meminfo中的 Committed_AS 表示所有进程已经申请的内存总大小，（注意是已经申请的，不是已经分配的），如果 
Committed_AS 超过&nbsp;CommitLimit 就表示发生了 overcommit，超出越多表示 overcommit 
越严重。Committed_AS 的含义换一种说法就是，如果要绝对保证不发生OOM (out of memory) 需要多少物理内存。</p>
<p><em>“sar -r”是查看内存使用状况的常用工具，它的输出结果中有两个与overcommit有关，kbcommit 和 %commit：</em><br>
<em>kbcommit对应/proc/meminfo中的 Committed_AS；</em><br>
<em>%commit的计算公式并没有采用 CommitLimit作分母，而是Committed_AS/(MemTotal+SwapTotal)，意思是_内存申请_占_物理内存与交换区之和_的百分比。</em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-59b753a515184627593923" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">$ sar -r 

05:00:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
05:10:01 PM    160576   3648460     95.78         0   1846212   4939368     62.74   1390292   1854880         4</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="margin-left: -18px;">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59b753a515184627593923-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a515184627593923-2">2</div><div class="crayon-num" data-line="crayon-59b753a515184627593923-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a515184627593923-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59b753a515184627593923-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">sar</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">r</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a515184627593923-2">&nbsp;</div><div class="crayon-line" id="crayon-59b753a515184627593923-3"><span class="crayon-cn">05</span><span class="crayon-o">:</span><span class="crayon-cn">00</span><span class="crayon-o">:</span><span class="crayon-cn">01</span><span class="crayon-h"> </span><span class="crayon-e">PM </span><span class="crayon-e">kbmemfree </span><span class="crayon-v">kbmemused</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">%</span><span class="crayon-e">memused </span><span class="crayon-e">kbbuffers&nbsp;&nbsp;</span><span class="crayon-e">kbcached&nbsp;&nbsp;</span><span class="crayon-v">kbcommit</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">%</span><span class="crayon-e">commit&nbsp;&nbsp;</span><span class="crayon-e">kbactive&nbsp;&nbsp; </span><span class="crayon-e">kbinact&nbsp;&nbsp; </span><span class="crayon-i">kbdirty</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a515184627593923-4"><span class="crayon-cn">05</span><span class="crayon-o">:</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">01</span><span class="crayon-h"> </span><span class="crayon-i">PM</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">160576</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">3648460</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">95.78</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">1846212</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">4939368</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">62.74</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">1390292</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">1854880</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">4</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p></p>
<h6>附：对Heuristic overcommit算法的解释</h6>
<p>内核参数 vm.overcommit_memory 的值0，1，2对应的源代码如下，其中heuristic overcommit对应的是OVERCOMMIT_GUESS：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-59b753a515188066216086" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">源文件：source/include/linux/mman.h

#define OVERCOMMIT_GUESS                0
#define OVERCOMMIT_ALWAYS               1
#define OVERCOMMIT_NEVER                2</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="margin-left: -18px;">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59b753a515188066216086-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a515188066216086-2">2</div><div class="crayon-num" data-line="crayon-59b753a515188066216086-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a515188066216086-4">4</div><div class="crayon-num" data-line="crayon-59b753a515188066216086-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59b753a515188066216086-1">源文件：<span class="crayon-v">source</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-v">linux</span><span class="crayon-o">/</span><span class="crayon-v">mman</span><span class="crayon-sy">.</span><span class="crayon-v">h</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a515188066216086-2">&nbsp;</div><div class="crayon-line" id="crayon-59b753a515188066216086-3"><span class="crayon-p">#define OVERCOMMIT_GUESS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a515188066216086-4"><span class="crayon-p">#define OVERCOMMIT_ALWAYS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span></div><div class="crayon-line" id="crayon-59b753a515188066216086-5"><span class="crayon-p">#define OVERCOMMIT_NEVER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Heuristic overcommit算法在以下函数中实现，基本上可以这么理解：<br>
单次申请的内存大小不能超过 【free memory + free swap +&nbsp;pagecache的大小 + SLAB中可回收的部分】，否则本次申请就会失败。</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-59b753a51518b226011305" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">源文件：source/mm/mmap.c 以RHEL内核2.6.32-642为例

0120 /*
0121  * Check that a process has enough memory to allocate a new virtual
0122  * mapping. 0 means there is enough memory for the allocation to
0123  * succeed and -ENOMEM implies there is not.
0124  *
0125  * We currently support three overcommit policies, which are set via the
0126  * vm.overcommit_memory sysctl.  See Documentation/vm/overcommit-accounting
0127  *
0128  * Strict overcommit modes added 2002 Feb 26 by Alan Cox.
0129  * Additional code 2002 Jul 20 by Robert Love.
0130  *
0131  * cap_sys_admin is 1 if the process has admin privileges, 0 otherwise.
0132  *
0133  * Note this is a helper function intended to be used by LSMs which
0134  * wish to use this logic.
0135  */
0136 int __vm_enough_memory(struct mm_struct *mm, long pages, int cap_sys_admin)
0137 {
0138         unsigned long free, allowed;
0139 
0140         vm_acct_memory(pages);
0141 
0142         /*
0143          * Sometimes we want to use more memory than we have
0144          */
0145         if (sysctl_overcommit_memory == OVERCOMMIT_ALWAYS)
0146                 return 0;
0147 
0148         if (sysctl_overcommit_memory == OVERCOMMIT_GUESS) { //Heuristic overcommit算法开始
0149                 unsigned long n;
0150 
0151                 free = global_page_state(NR_FILE_PAGES); //pagecache汇总的页面数量
0152                 free += get_nr_swap_pages(); //free swap的页面数
0153 
0154                 /*
0155                  * Any slabs which are created with the
0156                  * SLAB_RECLAIM_ACCOUNT flag claim to have contents
0157                  * which are reclaimable, under pressure.  The dentry
0158                  * cache and most inode caches should fall into this
0159                  */
0160                 free += global_page_state(NR_SLAB_RECLAIMABLE); //SLAB可回收的页面数
0161 
0162                 /*
0163                  * Reserve some for root
0164                  */
0165                 if (!cap_sys_admin)
0166                         free -= sysctl_admin_reserve_kbytes &gt;&gt; (PAGE_SHIFT - 10); //给root用户保留的页面数
0167 
0168                 if (free &gt; pages)
0169                         return 0;
0170 
0171                 /*
0172                  * nr_free_pages() is very expensive on large systems,
0173                  * only call if we're about to fail.
0174                  */
0175                 n = nr_free_pages(); //当前free memory页面数
0176 
0177                 /*
0178                  * Leave reserved pages. The pages are not for anonymous pages.
0179                  */
0180                 if (n &lt;= totalreserve_pages)
0181                         goto error;
0182                 else
0183                         n -= totalreserve_pages;
0184 
0185                 /*
0186                  * Leave the last 3% for root
0187                  */
0188                 if (!cap_sys_admin)
0189                         n -= n / 32;
0190                 free += n;
0191 
0192                 if (free &gt; pages)
0193                         return 0;
0194 
0195                 goto error;
0196         }
0197 
0198         allowed = vm_commit_limit();
0199         /*
0200          * Reserve some for root
0201          */
0202         if (!cap_sys_admin)
0203                 allowed -= sysctl_admin_reserve_kbytes &gt;&gt; (PAGE_SHIFT - 10);
0204 
0205         /* Don't let a single process grow too big:
0206            leave 3% of the size of this process for other processes */
0207         if (mm)
0208                 allowed -= mm-&gt;total_vm / 32;
0209 
0210         if (percpu_counter_read_positive(&amp;vm_committed_as) &lt; allowed)
0211                 return 0;
0212 error:
0213         vm_unacct_memory(pages);
0214 
0215         return -ENOMEM;
0216 }</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="margin-left: -25px;">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59b753a51518b226011305-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-2">2</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-4">4</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-6">6</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-8">8</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-10">10</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-12">12</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-14">14</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-16">16</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-18">18</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-20">20</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-22">22</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-24">24</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-26">26</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-28">28</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-30">30</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-32">32</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-34">34</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-36">36</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-38">38</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-40">40</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-42">42</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-44">44</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-46">46</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-48">48</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-50">50</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-52">52</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-54">54</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-56">56</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-58">58</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-60">60</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-62">62</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-64">64</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-66">66</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-68">68</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-70">70</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-72">72</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-74">74</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-76">76</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-78">78</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-80">80</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-82">82</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-84">84</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-86">86</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-88">88</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-90">90</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-92">92</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-94">94</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-96">96</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-59b753a51518b226011305-98">98</div><div class="crayon-num" data-line="crayon-59b753a51518b226011305-99">99</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59b753a51518b226011305-1">源文件：<span class="crayon-v">source</span><span class="crayon-o">/</span><span class="crayon-v">mm</span><span class="crayon-o">/</span><span class="crayon-v">mmap</span><span class="crayon-sy">.</span><span class="crayon-i">c</span><span class="crayon-h"> </span>以<span class="crayon-i">RHEL</span>内核<span class="crayon-cn">2.6.32</span><span class="crayon-o">-</span><span class="crayon-cn">642</span>为例</div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-2">&nbsp;</div><div class="crayon-line" id="crayon-59b753a51518b226011305-3"><span class="crayon-cn">0120</span><span class="crayon-h"> </span><span class="crayon-c">/*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-4"><span class="crayon-c">0121&nbsp;&nbsp;* Check that a process has enough memory to allocate a new virtual</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-5"><span class="crayon-c">0122&nbsp;&nbsp;* mapping. 0 means there is enough memory for the allocation to</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-6"><span class="crayon-c">0123&nbsp;&nbsp;* succeed and -ENOMEM implies there is not.</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-7"><span class="crayon-c">0124&nbsp;&nbsp;*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-8"><span class="crayon-c">0125&nbsp;&nbsp;* We currently support three overcommit policies, which are set via the</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-9"><span class="crayon-c">0126&nbsp;&nbsp;* vm.overcommit_memory sysctl.&nbsp;&nbsp;See Documentation/vm/overcommit-accounting</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-10"><span class="crayon-c">0127&nbsp;&nbsp;*</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-11"><span class="crayon-c">0128&nbsp;&nbsp;* Strict overcommit modes added 2002 Feb 26 by Alan Cox.</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-12"><span class="crayon-c">0129&nbsp;&nbsp;* Additional code 2002 Jul 20 by Robert Love.</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-13"><span class="crayon-c">0130&nbsp;&nbsp;*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-14"><span class="crayon-c">0131&nbsp;&nbsp;* cap_sys_admin is 1 if the process has admin privileges, 0 otherwise.</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-15"><span class="crayon-c">0132&nbsp;&nbsp;*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-16"><span class="crayon-c">0133&nbsp;&nbsp;* Note this is a helper function intended to be used by LSMs which</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-17"><span class="crayon-c">0134&nbsp;&nbsp;* wish to use this logic.</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-18"><span class="crayon-c">0135&nbsp;&nbsp;*/</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-19"><span class="crayon-cn">0136</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">__vm_enough_memory</span><span class="crayon-sy">(</span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-v">mm_struct</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">mm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">pages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">cap_sys_admin</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-20"><span class="crayon-cn">0137</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-21"><span class="crayon-cn">0138</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">free</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">allowed</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-22"><span class="crayon-cn">0139</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-23"><span class="crayon-cn">0140</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">vm_acct_memory</span><span class="crayon-sy">(</span><span class="crayon-v">pages</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-24"><span class="crayon-cn">0141</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-25"><span class="crayon-cn">0142</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-26"><span class="crayon-c">0143&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Sometimes we want to use more memory than we have</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-27"><span class="crayon-c">0144&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-28"><span class="crayon-cn">0145</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">sysctl_overcommit_memory</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">OVERCOMMIT_ALWAYS</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-29"><span class="crayon-cn">0146</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-30"><span class="crayon-cn">0147</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-31"><span class="crayon-cn">0148</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">sysctl_overcommit_memory</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">OVERCOMMIT_GUESS</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//Heuristic overcommit算法开始</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-32"><span class="crayon-cn">0149</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-33"><span class="crayon-cn">0150</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-34"><span class="crayon-cn">0151</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">global_page_state</span><span class="crayon-sy">(</span><span class="crayon-v">NR_FILE_PAGES</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//pagecache汇总的页面数量</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-35"><span class="crayon-cn">0152</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">get_nr_swap_pages</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//free swap的页面数</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-36"><span class="crayon-cn">0153</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-37"><span class="crayon-cn">0154</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-38"><span class="crayon-c">0155&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Any slabs which are created with the</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-39"><span class="crayon-c">0156&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* SLAB_RECLAIM_ACCOUNT flag claim to have contents</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-40"><span class="crayon-c">0157&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* which are reclaimable, under pressure.&nbsp;&nbsp;The dentry</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-41"><span class="crayon-c">0158&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* cache and most inode caches should fall into this</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-42"><span class="crayon-c">0159&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-43"><span class="crayon-cn">0160</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">global_page_state</span><span class="crayon-sy">(</span><span class="crayon-v">NR_SLAB_RECLAIMABLE</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//SLAB可回收的页面数</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-44"><span class="crayon-cn">0161</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-45"><span class="crayon-cn">0162</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-46"><span class="crayon-c">0163&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Reserve some for root</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-47"><span class="crayon-c">0164&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-48"><span class="crayon-cn">0165</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">cap_sys_admin</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-49"><span class="crayon-cn">0166</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-v">sysctl_admin_reserve_kbytes</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">PAGE_SHIFT</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//给root用户保留的页面数</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-50"><span class="crayon-cn">0167</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-51"><span class="crayon-cn">0168</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">pages</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-52"><span class="crayon-cn">0169</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-53"><span class="crayon-cn">0170</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-54"><span class="crayon-cn">0171</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-55"><span class="crayon-c">0172&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* nr_free_pages() is very expensive on large systems,</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-56"><span class="crayon-c">0173&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* only call if we're about to fail.</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-57"><span class="crayon-c">0174&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-58"><span class="crayon-cn">0175</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">n</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">nr_free_pages</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//当前free memory页面数</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-59"><span class="crayon-cn">0176</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-60"><span class="crayon-cn">0177</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-61"><span class="crayon-c">0178&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Leave reserved pages. The pages are not for anonymous pages.</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-62"><span class="crayon-c">0179&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-63"><span class="crayon-cn">0180</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">n</span><span class="crayon-h"> </span><span class="crayon-o">&lt;=</span><span class="crayon-h"> </span><span class="crayon-v">totalreserve_pages</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-64"><span class="crayon-cn">0181</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">goto</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-65"><span class="crayon-cn">0182</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-66"><span class="crayon-cn">0183</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">n</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-v">totalreserve_pages</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-67"><span class="crayon-cn">0184</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-68"><span class="crayon-cn">0185</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-69"><span class="crayon-c">0186&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Leave the last 3% for root</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-70"><span class="crayon-c">0187&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-71"><span class="crayon-cn">0188</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">cap_sys_admin</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-72"><span class="crayon-cn">0189</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">n</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">32</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-73"><span class="crayon-cn">0190</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-74"><span class="crayon-cn">0191</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-75"><span class="crayon-cn">0192</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">free</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">pages</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-76"><span class="crayon-cn">0193</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-77"><span class="crayon-cn">0194</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-78"><span class="crayon-cn">0195</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">goto</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-79"><span class="crayon-cn">0196</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-80"><span class="crayon-cn">0197</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-81"><span class="crayon-cn">0198</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">vm_commit_limit</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-82"><span class="crayon-cn">0199</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/*</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-83"><span class="crayon-c">0200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Reserve some for root</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-84"><span class="crayon-c">0201&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-85"><span class="crayon-cn">0202</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">cap_sys_admin</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-86"><span class="crayon-cn">0203</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">allowed</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-v">sysctl_admin_reserve_kbytes</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">PAGE_SHIFT</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-87"><span class="crayon-cn">0204</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-88"><span class="crayon-cn">0205</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">/* Don't let a single process grow too big:</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-89"><span class="crayon-c">0206&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave 3% of the size of this process for other processes */</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-90"><span class="crayon-cn">0207</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">mm</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-91"><span class="crayon-cn">0208</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">allowed</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-v">mm</span><span class="crayon-o">-&gt;</span><span class="crayon-v">total_vm</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">32</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-92"><span class="crayon-cn">0209</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-93"><span class="crayon-cn">0210</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">percpu_counter_read_positive</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">vm_committed_as</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">allowed</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-94"><span class="crayon-cn">0211</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-95"><span class="crayon-cn">0212</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-96"><span class="crayon-cn">0213</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">vm_unacct_memory</span><span class="crayon-sy">(</span><span class="crayon-v">pages</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-97"><span class="crayon-cn">0214</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-59b753a51518b226011305-98"><span class="crayon-cn">0215</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">ENOMEM</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-59b753a51518b226011305-99"><span class="crayon-cn">0216</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0150 seconds] -->
<p>&nbsp;</p>
<p>参考：<br>
<a href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting" target="_blank">https://www.kernel.org/doc/Documentation/vm/overcommit-accounting</a><br>
<a href="https://www.win.tue.nl/%7Eaeb/linux/lk/lk-9.html" target="_blank">https://www.win.tue.nl/~aeb/linux/lk/lk-9.html</a><br>
<a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt" target="_blank">https://www.kernel.org/doc/Documentation/sysctl/vm.txt</a><br>
<a href="http://lwn.net/Articles/28345/" target="_blank">http://lwn.net/Articles/28345/</a></p>
	</div><!-- .entry-content -->
	
	</article><!-- #post-## -->
	<nav class="navigation post-navigation" role="navigation">
		<h1 class="screen-reader-text">文章导航</h1>
		<div class="nav-links">
			<a href="http://linuxperf.com/?p=97" rel="prev"><span class="meta-nav">上一文章</span>解读vmstat中的active/inactive memory</a><a href="http://linuxperf.com/?p=105" rel="next"><span class="meta-nav">下一文章</span>怎样诊断Machine-check Exception</a>		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
			</div><!-- #content -->
	</div><!-- #primary -->

<div id="secondary">
		<h2 class="site-description"><a href="http://weibo.com/vmunix"><img src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/logo.jpg" title="@vmunix"></a></h2>
	
	
		<div id="primary-sidebar" class="primary-sidebar widget-area" role="complementary">
		<aside id="categories-2" class="widget widget_categories"><h1 class="widget-title">目　录</h1>		<ul>
	<li class="cat-item cat-item-12"><a href="http://linuxperf.com/?cat=12">crash分析</a> (6)
</li>
	<li class="cat-item cat-item-11"><a href="http://linuxperf.com/?cat=11">IO</a> (4)
</li>
	<li class="cat-item cat-item-5"><a href="http://linuxperf.com/?cat=5">IPC</a> (4)
</li>
	<li class="cat-item cat-item-1"><a href="http://linuxperf.com/?cat=1">其他</a> (2)
</li>
	<li class="cat-item cat-item-7"><a href="http://linuxperf.com/?cat=7">内存</a> (9)
</li>
	<li class="cat-item cat-item-4"><a href="http://linuxperf.com/?cat=4">性能工具</a> (9)
</li>
	<li class="cat-item cat-item-13"><a href="http://linuxperf.com/?cat=13">文件系统</a> (1)
</li>
	<li class="cat-item cat-item-2"><a href="http://linuxperf.com/?cat=2">网络</a> (5)
</li>
	<li class="cat-item cat-item-9"><a href="http://linuxperf.com/?cat=9">读核笔记</a> (6)
</li>
	<li class="cat-item cat-item-10"><a href="http://linuxperf.com/?cat=10">进程管理</a> (2)
</li>
		</ul>
</aside>	</div><!-- #primary-sidebar -->
	</div><!-- #secondary -->

		</div><!-- #main -->

		<footer id="colophon" class="site-footer" role="contentinfo">

			
			<div class="site-info">
								<a href="http://weibo.com/vmunix">@vmunix</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<script type="text/javascript" src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/functions.js"></script>
<script type="text/javascript" src="%E7%90%86%E8%A7%A3Linux%E7%9A%84memory%20overcommit%20%7C%20Linux%20Performance_files/wp-embed.js"></script>



</body></html>